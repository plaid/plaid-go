package release

import (
	"fmt"
	"go/build"
	"os"
	"path/filepath"
	"strings"
	"text/template"

	"github.com/coreos/go-semver/semver"
	"github.com/plaid/plaid-go/internal"
)

var versionTmpl = template.Must(template.New("var").Parse(strings.TrimSpace(`
// NOTE - this file is auto-generated.
package internal

// Version is the current version of the plaid-go library
var Version = "{{.Version}}"
`) + "\n"))

func incrementVersion(release releaseType) error {
	// Get the current semantic version
	v, err := semver.NewVersion(internal.Version)
	if err != nil {
		return err
	}

	switch release {
	case major:
		v.BumpMajor()
	case minor:
		v.BumpMinor()
	case patch:
		v.BumpPatch()
	default:
		return fmt.Errorf("invalid releaseType %v", release)
	}

	pkg, err := build.Import("github.com/plaid/plaid-go/internal", "", build.FindOnly)
	if err != nil {
		return err
	}

	f, err := os.OpenFile(filepath.Join(pkg.Dir, "version_autogenerated.go"), os.O_RDWR|os.O_CREATE, 0755)
	if err != nil {
		return err
	}

	if err := versionTmpl.Execute(f, struct {
		Version string
	}{
		Version: v.String(),
	}); err != nil {
		return err
	}

	return nil
}
